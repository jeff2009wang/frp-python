# frp-python

> frp 是一个专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。

frp-python 是基于 frp 原理实现的轻量级 Python 版 frp，frp-python 具有非常简洁的设计，在速度方面甚至优于 frp。如果你愿意，只需稍加修改 frpc 的代码，甚至可以在 esp-32 上部署一个 frpc 客户端！

关于 frp 原理，可以参考 [内网穿透工具 frp 核心架构原理分析](https://blog.csdn.net/usualheart/article/details/123032372)

## 特性

### 性能优化
- **低延迟传输**：启用 TCP_NODELAY，禁用 Nagle 算法
- **大带宽支持**：缓冲区增加到 64KB
- **连接保活**：启用 TCP KEEPALIVE，自动检测并恢复断开的连接
- **连接池**：预建立连接池，减少连接建立延迟

### 自动化功能
- **端口自动扫描**：定期扫描本地端口，自动发现运行中的服务
- **智能 FRP 管理**：根据端口扫描结果自动创建/关闭 FRP 连接
- **稳定性检测**：端口稳定性检测，避免频繁切换
- **自动重连**：客户端断线自动重连，服务端自动清理过期连接

## 使用方法

### 1. 启动服务端（FRPS）

在有公网 IP 的服务器上运行：

```bash
python frps.py <frps_port> <user_port>
```

**示例**：
```bash
python frps.py 7000 8001
```

- `frps_port`：FRP 控制端口，客户端连接用（示例中为 7000）
- `user_port`：对外暴露的用户端口，外部访问用（示例中为 8001）

---

### 2. 启动自动客户端（Auto-FRPC）

在内网机器上运行：

```bash
python auto_frpc.py <server_host> <server_port> [options]
```

**基础示例**：
```bash
python auto_frpc.py 192.168.1.100 7000
```

这会：
- 连接到服务器 `192.168.1.100:7000`
- 自动扫描 localhost 的所有端口（1-65535）
- 发现端口有服务运行时，自动创建 FRP 连接
- 服务关闭时，自动关闭 FRP 连接

---

### 3. 命令行参数说明

**auto_frpc.py 参数**：

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--target HOST` | 要扫描的目标主机 | localhost |
| `--interval SECONDS` | 扫描间隔（秒） | 30 |
| `--pool-size NUM` | 连接池大小 | 5 |
| `--ports PORTS` | 要监控的端口列表（逗号分隔） | 无（扫描所有端口） |
| `--stable-time SECONDS` | 端口稳定时间（秒） | 10 |
| `--status` | 显示当前状态并退出 | - |

---

### 4. 使用示例

#### 示例 1：扫描所有端口

```bash
python auto_frpc.py 192.168.1.100 7000
```

自动扫描 localhost 的所有端口（1-65535），发现服务后自动穿透。

---

#### 示例 2：只监控特定端口

```bash
python auto_frpc.py 192.168.1.100 7000 --ports 22,80,3389
```

只监控 SSH(22)、HTTP(80)、RDP(3389) 这三个端口。

---

#### 示例 3：自定义扫描间隔和连接池

```bash
python auto_frpc.py 192.168.1.100 7000 --interval 60 --pool-size 10
```

- 每 60 秒扫描一次
- 连接池大小为 10

---

#### 示例 4：高延迟网络环境

```bash
python auto_frpc.py 192.168.1.100 7000 --stable-time 20 --pool-size 15
```

- 要求端口稳定 20 秒后才创建 FRP（避免误判）
- 更大的连接池（15）以应对高延迟

---

#### 示例 5：查看当前状态

```bash
python auto_frpc.py 192.168.1.100 7000 --status
```

输出示例：
```json
{
  "active_connections": 2,
  "connections": [
    {
      "key": "22:22",
      "target_port": 22,
      "proxy_port": 22,
      "running": true,
      "uptime": 3600.5
    },
    {
      "key": "80:80",
      "target_port": 80,
      "proxy_port": 80,
      "running": true,
      "uptime": 1800.2
    }
  ]
}
```

---

### 5. 实际使用场景

#### 场景：自动穿透多个服务

**服务端**（公网服务器 123.45.67.89）：
```bash
python frps.py 7000 8001
```

**客户端**（内网机器）：
```bash
python auto_frpc.py 123.45.67.89 7000 --ports 22,80,443,3389,8080
```

**效果**：
- 当你在内网启动 SSH 服务（端口 22）时，自动可通过 `123.45.67.89:22` 访问
- 当你在内网启动 Web 服务（端口 80）时，自动可通过 `123.45.67.89:80` 访问
- 当你在内网启动远程桌面（端口 3389）时，自动可通过 `123.45.67.89:3389` 访问
- 服务关闭后，对应的穿透自动停止

---

### 6. 端口扫描器单独使用

如果只需要端口扫描功能：

```bash
python port_scanner.py <scan_interval> [ports]
```

**示例**：
```bash
python port_scanner.py 30 22,80,3389
```

每 30 秒扫描一次端口 22、80、3389。

---

## 文件说明

| 文件 | 说明 |
|------|------|
| [frps.py](frps.py) | FRPS 服务端，监听用户连接和客户端连接 |
| [frpc.py](frpc.py) | FRPC 客户端核心模块，被 auto_frpc 调用 |
| [auto_frpc.py](auto_frpc.py) | 自动 FRP 管理器，根据端口扫描自动创建/关闭 FRP 连接 |
| [port_scanner.py](port_scanner.py) | 端口扫描器，支持定期扫描本地活跃端口 |
| [lib/ConnTool.py](lib/ConnTool.py) | 连接工具模块，优化的数据传输 |

---

## 性能优化详解

### 1. TCP 参数优化

- **TCP_NODELAY**：禁用 Nagle 算法，减少小数据包延迟
- **SO_KEEPALIVE**：启用 TCP 保活机制，自动检测死连接
- **TCP_KEEPIDLE**：30 秒后开始发送保活探测
- **TCP_KEEPINTVL**：保活探测间隔 10 秒
- **TCP_KEEPCNT**：最多发送 3 次保活探测

### 2. 缓冲区优化

- **接收缓冲区**：64KB
- **连接池**：预建立多个连接，减少连接建立延迟

### 3. 连接管理优化

- **自动重连**：客户端断线后自动重连
- **连接池维护**：动态维护连接池，确保始终有可用连接
- **超时检测**：服务端自动清理超时连接

---

## 注意事项

1. **端口稳定性**：为了避免频繁切换，默认要求端口稳定运行 10 秒后才创建 FRP 连接
2. **连接池大小**：连接池大小建议设置为 5-10，太小会影响性能，太大占用资源
3. **扫描间隔**：扫描间隔建议设置为 30-60 秒，太频繁会消耗资源
4. **防火墙**：确保服务端和客户端的防火墙允许相应端口的通信
5. **端口范围**：如果不指定 `--ports`，会扫描 1-65535 所有端口，这会比较耗时

---

## 故障排除

### 客户端无法连接服务端

- 检查服务端是否正常运行
- 检查网络连通性
- 检查防火墙设置

### 端口扫描不准确

- 增加 `--stable-time` 参数
- 检查目标主机防火墙设置

### 性能问题

- 增加连接池大小 `--pool-size`
- 检查网络带宽

---

## 工作原理

1. **服务端启动**：监听两个端口，一个用于接收用户请求，一个用于客户端连接
2. **客户端启动**：连接到服务端，建立控制通道
3. **端口扫描**：定期扫描本地端口，发现运行中的服务
4. **自动穿透**：发现稳定运行的服务后，自动创建 FRP 连接
5. **数据转发**：用户请求通过服务端转发到客户端，再转发到目标服务

---

## 许可证

本项目遵循原 FRP 项目的许可证。
